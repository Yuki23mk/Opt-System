generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                Int                 @id @default(autoincrement())
  email             String              @unique
  password          String
  systemRole        String              @default("user")
  status            String              @default("pending")
  createdAt         DateTime            @default(now())
  name              String
  companyId         Int
  department        String?
  position          String?
  phone             String?
  createdById       Int?
  permissions       Json?
  
  // âœ… 2FAé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
  twoFactorEnabled  Boolean             @default(false)        // 2FAæœ‰åŠ¹/ç„¡åŠ¹
  twoFactorSecret   String?                                    // TOTPã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼
  backupCodes       Json?                                      // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ï¼ˆJSONé…åˆ—ï¼‰
  
  // ğŸ†• ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  resetToken        String?                                    // ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³
  resetTokenExpiry  DateTime?                                  // ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™
  
  addresses         Address[]
  Cart              Cart[]              @relation("UserToCart")
  equipments        Equipment[]
  uploadedDocuments EquipmentDocument[] @relation("UploadedDocuments")
  addedMaterials    EquipmentMaterial[] @relation("AddedMaterials")
  orders            Order[]
  createdBy         User?               @relation("UserCreatedBy", fields: [createdById], references: [id])
  children          User[]              @relation("UserCreatedBy")
  companyRel        Company             @relation(fields: [companyId], references: [id])
  userTags          UserTag[]
  uploadedProductDocuments ProductDocument[] @relation("UploadedProductDocuments")
  productPreferences UserProductPreference[]
  // ğŸ†• åŒæ„ç®¡ç†é–¢é€£
  consents          UserConsent[]
}

// ğŸ†• æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæ„ç®¡ç†
model UserConsent {
  id            Int      @id @default(autoincrement())
  userId        Int
  documentType  String   // 'terms' | 'privacy' | 'beta-terms'
  documentVersion String // LegalDocumentã®versionã¨å¯¾å¿œ
  agreedAt      DateTime @default(now())
  ipAddress     String?  // åŒæ„æ™‚ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹
  userAgent     String?  // åŒæ„æ™‚ã®ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, documentType, documentVersion])
  @@index([userId, documentType])
}

// â˜…â˜…â˜… Productãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ â˜…â˜…â˜…
// å…¨ã¦AdminProductMaster + CompanyProductãƒ™ãƒ¼ã‚¹ã«çµ±ä¸€

model UserTag {
  id               Int                @id @default(autoincrement())
  productMasterId  Int                
  userId           Int
  companyId        Int
  name             String
  color            String             @default("blue")
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  company          Company            @relation(fields: [companyId], references: [id])
  user             User               @relation(fields: [userId], references: [id])
  productMaster    AdminProductMaster @relation(fields: [productMasterId], references: [id], onDelete: Cascade)

  @@unique([productMasterId, userId, name])
}

model UserProductPreference {
  id               Int      @id @default(autoincrement())
  userId           Int
  companyProductId Int      
  visible          Boolean  @default(true)  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  user             User             @relation(fields: [userId], references: [id])
  companyProduct   CompanyProduct   @relation(fields: [companyProductId], references: [id])
  
  @@unique([userId, companyProductId])
}

model Order {
  id                  Int         @id @default(autoincrement())
  orderNumber         String      @unique
  userId              Int
  totalAmount         Float
  status              String      @default("pending")
  deliveryAddressId   Int?
  deliveryName        String
  deliveryCompany     String?
  deliveryZipCode     String
  deliveryPrefecture  String
  deliveryCity        String
  deliveryAddress1    String
  deliveryAddress2    String?
  deliveryPhone       String?
  cancelReason        String?
  cancelRejectReason  String? 
  adminNote          String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  user               User        @relation(fields: [userId], references: [id])
  orderItems         OrderItem[]
  deliveryAddress    Address?    @relation(fields: [deliveryAddressId], references: [id])
  paperwork     OrderPaperwork[] 
}

model OrderItem {
  id               Int            @id @default(autoincrement())
  orderId          Int
  companyProductId Int            // â˜…â˜…â˜… å¤‰æ›´ï¼šproductId â†’ companyProductId
  quantity         Int
  unitPrice        Float
  totalPrice       Float
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  companyProduct   CompanyProduct @relation(fields: [companyProductId], references: [id]) // â˜…â˜…â˜… å¤‰æ›´
}

model Address {
  id          Int      @id @default(autoincrement())
  userId      Int
  name        String
  company     String?
  zipCode     String
  prefecture  String
  city        String
  address1    String
  address2    String?
  phone       String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  User        User     @relation(fields: [userId], references: [id])
  orders      Order[]
}

model Cart {
  id               Int            @id @default(autoincrement())
  userId           Int
  companyProductId Int            // â˜…â˜…â˜… å¤‰æ›´ï¼šproductId â†’ companyProductId
  quantity         Int
  createdAt        DateTime       @default(now())
  user             User           @relation("UserToCart", fields: [userId], references: [id])
  companyProduct   CompanyProduct @relation("UserToCart", fields: [companyProductId], references: [id]) // â˜…â˜…â˜… å¤‰æ›´
}


model Equipment {
  id           Int                 @id @default(autoincrement())
  code         String              @unique
  category     String
  name         String
  manufacturer String
  location     String?
  manager      String?
  userId       Int
  companyId    Int
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  company      Company             @relation(fields: [companyId], references: [id])
  user         User                @relation(fields: [userId], references: [id])
  documents    EquipmentDocument[]
  materials    EquipmentMaterial[]
}

model EquipmentDocument {
  id             Int       @id @default(autoincrement())
  equipmentId    Int
  uploadedById   Int
  companyId      Int
  filename       String
  storedFilename String?
  s3Url          String?
  mimeType       String?
  size           Int?
  createdAt      DateTime  @default(now())
  company        Company   @relation("CompanyDocuments", fields: [companyId], references: [id])
  uploadedBy     User      @relation("UploadedDocuments", fields: [uploadedById], references: [id])
  equipment      Equipment @relation(fields: [equipmentId], references: [id])
}

model EquipmentMaterial {
  id               Int            @id @default(autoincrement())
  equipmentId      Int
  companyProductId Int            // â˜…â˜…â˜… å¤‰æ›´ï¼šproductId â†’ companyProductId
  addedByUserId    Int
  companyId        Int
  usagePriority    Int?
  defaultQty       Int?
  unit             String?
  createdAt        DateTime       @default(now())
  company          Company        @relation("CompanyMaterials", fields: [companyId], references: [id])
  addedBy          User           @relation("AddedMaterials", fields: [addedByUserId], references: [id])
  companyProduct   CompanyProduct @relation(fields: [companyProductId], references: [id]) // â˜…â˜…â˜… å¤‰æ›´
  equipment        Equipment      @relation(fields: [equipmentId], references: [id])
}

model Company {
  id                 Int                   @id @default(autoincrement())
  name               String
  createdAt          DateTime              @default(now())
  companyProducts    CompanyProduct[]
  categories         DataMonitorCategory[]
  equipments         Equipment[]
  equipmentDocuments EquipmentDocument[]   @relation("CompanyDocuments")
  equipmentMaterials EquipmentMaterial[]   @relation("CompanyMaterials")
  users              User[]
  userTags           UserTag[]
  productDocuments   ProductDocument[]     @relation("CompanyProductDocuments")
}

model DataMonitorCategory {
  id        Int                  @id @default(autoincrement())
  name      String
  companyId Int
  createdAt DateTime             @default(now())
  company   Company              @relation(fields: [companyId], references: [id])
  projects  DataMonitorProject[]
}

model DataMonitorProject {
  id               Int                      @id @default(autoincrement())
  name             String
  categoryId       Int
  limitSettings    Json?                   
  fluidType        String?                  
  machineId        String?   
  measurementFields Json?                  // ğŸ†• ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®æ¸¬å®šé …ç›®
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @default(now()) @updatedAt
  measurements     DataMonitorMeasurement[]
  category         DataMonitorCategory      @relation(fields: [categoryId], references: [id])
}

model DataMonitorMeasurement {
  id            Int                @id @default(autoincrement())
  projectId     Int
  date          DateTime
  values        Json
  note          String?
  validationStatus String?         
  alertFlags    Json?                       
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @default(now()) @updatedAt
  project       DataMonitorProject @relation(fields: [projectId], references: [id])
  
  @@index([projectId, date])
}

model ProductDocument {
  id               Int                @id @default(autoincrement())
  productMasterId  Int                // â˜…â˜…â˜… å¤‰æ›´ï¼šproductId â†’ productMasterId
  companyId        Int
  uploadedById     Int?               // â˜…â˜…â˜… nullable ã«å¤‰æ›´
  uploadedByAdminId Int?              // â˜…â˜…â˜… ç®¡ç†è€…IDç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
  filename         String
  storedFilename   String?
  s3Url            String?
  mimeType         String?
  size             Int?
  category         String?            @default("manual")
  isPublic         Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  company          Company            @relation("CompanyProductDocuments", fields: [companyId], references: [id])
  uploadedBy       User?              @relation("UploadedProductDocuments", fields: [uploadedById], references: [id])
  uploadedByAdmin  AdminUser?         @relation("UploadedAdminDocuments", fields: [uploadedByAdminId], references: [id]) // â˜…â˜…â˜… è¿½åŠ 
  productMaster    AdminProductMaster @relation(fields: [productMasterId], references: [id], onDelete: Cascade) // â˜…â˜…â˜… å¤‰æ›´
}

// ç´å“æ›¸ãƒ»å—é ˜æ›¸ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
model OrderPaperwork {
  id            Int       @id @default(autoincrement())
  orderId       Int       
  documentType  String    // 'delivery_note' | 'receipt'
  documentNumber String   @unique // ç´å“æ›¸ç•ªå·ãƒ»å—é ˜æ›¸ç•ªå·
  filePath      String?   // PDFãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
  s3Url         String?   // S3 URL
  status        String    @default("draft") // 'draft' | 'finalized'
  deliveryDate  DateTime? // ç´æœŸæ—¥
  isApproved    Boolean   @default(false) // å—é ˜æ›¸æ‰¿èªãƒ•ãƒ©ã‚°
  approvedAt    DateTime? // æ‰¿èªæ—¥æ™‚
  approvedBy    String?   // æ‰¿èªè€…å
  createdById   Int       // ä½œæˆè€…ï¼ˆç®¡ç†è€…ï¼‰ID
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdBy     AdminUser @relation(fields: [createdById], references: [id])
  
  @@index([orderId, documentType])
  @@unique([orderId, documentType]) // 1ã¤ã®æ³¨æ–‡ã«å¯¾ã—ã¦å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¯1ã¤ã¾ã§
}

//ä»¥é™ã€ç®¡ç†è€…FEé–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
model AdminUser {
  id                Int                 @id @default(autoincrement())
  username          String              @unique
  passwordHash      String
  email             String              @unique
  role              String
  status            String              @default("active")
  lastLogin         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // âœ… ç®¡ç†è€…ç”¨2FAé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
  twoFactorEnabled  Boolean             @default(false)        // 2FAæœ‰åŠ¹/ç„¡åŠ¹
  twoFactorSecret   String?                                    // TOTPã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼  
  backupCodes       Json?                                      // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ï¼ˆJSONé…åˆ—ï¼‰
  
  uploadedDocuments AdminDocument[]
  uploadedProductDocuments ProductDocument[] @relation("UploadedAdminDocuments") // â˜…â˜…â˜… è¿½åŠ 
  sentNotifications AdminNotification[]
  operationLogs     AdminOperationLog[]
  adminUserNotes    AdminUserNote[]
  createdPaperwork OrderPaperwork[] 
   // ğŸ†• æ–°è¦è¿½åŠ ï¼šæ³•çš„æ–‡æ›¸ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  legalDocuments    LegalDocument[]
}

model AdminOperationLog {
  id         Int       @id @default(autoincrement())
  adminId    Int
  action     String
  targetType String?
  targetId   Int?
  details    String?
  createdAt  DateTime  @default(now())
  admin      AdminUser @relation(fields: [adminId], references: [id])
}

model AdminProductMaster {
  id              Int              @id @default(autoincrement())
  code            String           @unique
  name            String
  manufacturer    String
  capacity        String
  unit            String
  oilType         String
  internalTag     String?
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  companyProducts CompanyProduct[]
  userTags        UserTag[]        
  documents       ProductDocument[] // â˜…â˜…â˜… è¿½åŠ ï¼šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã®é–¢é€£
}

model CompanyProduct {
  id              Int                     @id @default(autoincrement())
  companyId       Int
  productMasterId Int
  enabled         Boolean                 @default(true)
  displayOrder    Int?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  price           Float?
  quotationExpiryDate DateTime?           // ğŸ†• è¦‹ç©æœŸé™
  productMaster   AdminProductMaster      @relation(fields: [productMasterId], references: [id])
  company         Company                 @relation(fields: [companyId], references: [id])
  userPreferences UserProductPreference[]
  priceSchedules  CompanyProductPriceSchedule[]  // ğŸ†• ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾¡æ ¼ã¨ã®é–¢é€£
  // â˜…â˜…â˜… ä»¥ä¸‹è¿½åŠ ï¼šå„ç¨®é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
  orderItems      OrderItem[]
  cartItems       Cart[]                  @relation("UserToCart")
  equipmentMaterials EquipmentMaterial[]
}

// ğŸ†• æ–°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾¡æ ¼å¤‰æ›´
model CompanyProductPriceSchedule {
  id               Int            @id @default(autoincrement())
  companyProductId Int
  scheduledPrice   Float
  effectiveDate    DateTime       // é©ç”¨é–‹å§‹æ—¥æ™‚
  expiryDate       DateTime?      // ğŸ†• é©ç”¨çµ‚äº†æ—¥æ™‚ï¼ˆæ–°è¦è¿½åŠ ï¼‰
  isApplied        Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  companyProduct   CompanyProduct @relation(fields: [companyProductId], references: [id], onDelete: Cascade)
  
  @@index([effectiveDate, isApplied])
}

model AdminUserNote {
  id        Int       @id @default(autoincrement())
  userId    Int
  adminId   Int
  note      String
  createdAt DateTime  @default(now())
  admin     AdminUser @relation(fields: [adminId], references: [id])
}

model AdminDocument {
  id           Int       @id @default(autoincrement())
  name         String
  type         String
  filePath     String
  relatedType  String?
  relatedId    Int?
  uploadedById Int
  createdAt    DateTime  @default(now())
  uploadedBy   AdminUser @relation(fields: [uploadedById], references: [id])
}

model AdminNotification {
  id         Int       @id @default(autoincrement())
  message    String
  targetType String
  targetId   Int?
  sentById   Int
  createdAt  DateTime  @default(now())
  sentBy     AdminUser @relation(fields: [sentById], references: [id])
}

model LegalDocument {
  id          Int      @id @default(autoincrement())
  type        String   // 'terms' | 'privacy' | 'beta-terms'
  title       String   
  content     String?  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼ˆS3ãŒãªã„å ´åˆï¼‰
  s3Key       String?  // S3ã®ã‚­ãƒ¼
  s3Url       String?  // å…¬é–‹URL
  version     String   
  isActive    Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   Int?     
  metadata    Json?    // ğŸ†• ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã€ã‚µã‚¤ã‚ºã€MIMEç­‰ï¼‰
  
  creator     AdminUser? @relation(fields: [createdBy], references: [id])
  
  @@index([type, isActive])
  @@unique([type, version])
}